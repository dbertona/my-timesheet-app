{"createdAt":"2025-09-03T06:32:12.599Z","updatedAt":"2025-09-03T06:43:57.000Z","id":"XSYOmZ8mRuaXl6sg","name":"001_sincronizacion_completa_smart","active":true,"isArchived":false,"nodes":[{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]); if (rows.length === 0) { return [{ json: { lastSyncIso: '1970-01-01T00:00:00Z' } }]; } const row = rows[0]; const last = row.last_sync_at || '1970-01-01T00:00:00Z'; const iso = new Date(last).toISOString(); return [{ json: { lastSyncIso: iso } }];"},"id":"4f8d503f-b6df-4b9c-8624-42e1e56320ed","name":"Compute last_sync ISO (tasks)","type":"n8n-nodes-base.code","typeVersion":2,"position":[4752,1152]},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies(ca9dc1bf-54ee-ed11-884a-000d3a455d5b)/ProyectosTareas?$filter=lastModifiedDateTime%20ge%20' + $json.lastSyncIso }}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"ba5066cf-26d5-409b-b676-b203365f411f","name":"HTTP - ProyectosTareas (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[4976,1152],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all(); if (input.length === 0) return []; const data = input[0].json; const tareas = data.value || []; const items = []; for (const t of tareas) { const job_no = t.projectNo || t.jobNo || t.job_no || ''; const no = t.no || ''; const description = (t.description && String(t.description).trim()) ? String(t.description).trim() : 'Sin descripción'; if (!job_no || !no) continue; items.push({ json: { job_no, no, description, company_name: 'Power Solution Iberia SL' }, pairedItem: { item: 0 } }); } return items;"},"id":"ed4b9f0d-1dfb-4434-8752-82d3cd8a94c4","name":"Transformar ProyectosTareas","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,1248]},{"parameters":{"batchSize":300,"options":{}},"id":"4c011fd7-b1a1-404c-9712-4ef8ad06c58c","name":"Split In Batches (upsert tasks)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[5424,1248]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json); return [{ json: { payload: rows } }];"},"id":"80bffba4-1203-499c-b544-6098aa4a00fd","name":"Pack batch (tasks)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5648,1248]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/job_task?on_conflict=company_name,job_no,no","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"81c8cb8a-ea8f-4937-a7ee-b4afc1d57021","name":"HTTP - Upsert job_task (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[5872,1248]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"d5351fae-33de-4cb5-ab49-13296356c9d4","name":"Compute now ISO (tasks)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,1056]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"Power Solution Iberia SL"},{"keyName":"entity","condition":"eq","keyValue":"job_task"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"41599ba8-8448-42da-bb96-a8afff6ce017","name":"Update sync_state (tasks)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5424,1056],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]); if (rows.length === 0) { return [{ json: { lastSyncIso: '1970-01-01T00:00:00Z' } }]; } const row = rows[0]; const last = row.last_sync_at || '1970-01-01T00:00:00Z'; const iso = new Date(last).toISOString(); return [{ json: { lastSyncIso: iso } }];"},"id":"20f984d3-1c4d-4381-9b79-c300427aa801","name":"Compute last_sync ISO (resource)","type":"n8n-nodes-base.code","typeVersion":2,"position":[720,1056]},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies(ca9dc1bf-54ee-ed11-884a-000d3a455d5b)/Recursos?$filter=lastModifiedDateTime%20ge%20' + $json.lastSyncIso }}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"518b75cc-eb82-4def-9026-481053e7ddbd","name":"HTTP - Recursos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[944,1056],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst first = input[0];\nconst data = first.json;\nconst recursos = data.value || [];\nconst items = [];\n\nfor (const r of recursos) {\n  const code = r.no || '';\n  const name = r.name || '';\n  const email = String(r.arbvrneMail ?? r.email ?? '').trim();\n  const department = String(r.globalDimension1Code ?? r.department ?? '').trim();\n  // Intenta varias claves según BC/AL\n  const calendarRaw = r.calendar_type ?? r.calendarType ?? r.Calendario ?? r.calendario ?? '';\n  const calendar_type = String(calendarRaw).trim();\n  const company = 'Power Solution Iberia SL';\n\n  // DESCARTAR si no hay email válido o no hay departamento\n  if (!email || !email.includes('@')) continue;\n  if (!department) continue;\n\n  items.push({\n    json: {\n      code,\n      name,\n      email,\n      department_code: department,\n      company_name: company,\n      calendar_type, // si viene vacío, el Pack batch ya pone 'DEFAULT'\n    },\n  });\n}\n\nreturn items;"},"id":"989cf7f9-23d5-48ed-9b2d-736693a3f957","name":"Transformar Recursos","type":"n8n-nodes-base.code","typeVersion":2,"position":[1168,960]},{"parameters":{"batchSize":300,"options":{}},"id":"285ebfbf-e0f5-48fe-a60d-6809984c25e4","name":"Split In Batches (upsert)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[1392,960]},{"parameters":{"jsCode":"const rows = $input.all().map(i => {\n  const j = i.json || {};\n  return {\n    ...j,\n    calendar_type: (j.calendar_type && String(j.calendar_type).trim())\n      || (j.calendarType && String(j.calendarType).trim())\n      || 'DEFAULT' // valor por defecto\n  };\n});\nreturn [{ json: { payload: rows } }];"},"id":"34cf9562-f01f-4882-8745-be96f7444271","name":"Pack batch","type":"n8n-nodes-base.code","typeVersion":2,"position":[1616,648]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/resource?on_conflict=company_name,code","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"59e1c56e-1e46-4186-9c52-f3d3cd647250","name":"HTTP - Upsert resource (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1840,960]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"56cfc9b9-a8ef-44e6-ab06-b04eee6af51c","name":"Compute now ISO (resource)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,1440]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"Power Solution Iberia SL"},{"keyName":"entity","condition":"eq","keyValue":"resource"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"1b4537c0-cb1f-450c-9e22-d5e0f2648e43","name":"Update sync_state (resource)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5424,1440],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"operation":"getAll","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').item.json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"job"}]}},"id":"6ffe393f-d9db-48b2-83f9-e00798ba5a4d","name":"Get sync_state (jobs)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-848,960],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]); if (rows.length === 0) { return [{ json: { lastSyncIso: '1970-01-01T00:00:00Z' } }]; } const row = rows[0]; const last = row.last_sync_at || '1970-01-01T00:00:00Z'; const iso = new Date(last).toISOString(); return [{ json: { lastSyncIso: iso } }];"},"id":"0537ef40-f6d8-4845-b05e-4dbf9b770e7d","name":"Compute last_sync ISO (jobs)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-624,960]},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies(ca9dc1bf-54ee-ed11-884a-000d3a455d5b)/Proyectos?$filter=lastModifiedDateTime%20ge%20' + $json.lastSyncIso }}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"f1cba719-7996-47e1-bda6-801e75c4bfe5","name":"HTTP - Proyectos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-400,960],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all(); if (input.length === 0) return []; const data = input[0].json; const proyectos = data.value || []; const items = []; const allowed = new Set(['Open','Planning','Completed','Lost']); for (const p of proyectos) { const statusRaw = p.estado ?? p.Estado ?? p.status ?? ''; const status = String(statusRaw).trim(); if (!allowed.has(status)) continue; items.push({ json: { no: p.no || '', description: p.description || '', status, responsible: p.Responsible || p.responsible || '', departamento: p.departamento || p.GlobalDimension1Code || '', company_name: 'Power Solution Iberia SL' }, pairedItem: { item: 0 } }); } return items;"},"id":"3f01aa43-02f1-4b20-bcea-7e5c05e424e2","name":"Transformar Proyectos","type":"n8n-nodes-base.code","typeVersion":2,"position":[-176,1056]},{"parameters":{"batchSize":300,"options":{}},"id":"8432912c-c02e-49e7-9cdb-eae4ea6d4277","name":"Split In Batches (upsert jobs)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[48,1056]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json); return [{ json: { payload: rows } }];"},"id":"5e11c979-2355-4622-ab00-8e715d0c4d1f","name":"Pack batch (jobs)","type":"n8n-nodes-base.code","typeVersion":2,"position":[272,648]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/job?on_conflict=company_name,no","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"f6962ae9-624c-4192-b3ff-95d974544359","name":"HTTP - Upsert job (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[496,1056]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"cd7ed1e5-0cdd-4a54-84ae-a1e97a75ed39","name":"Compute now ISO (jobs)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,480]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"Power Solution Iberia SL"},{"keyName":"entity","condition":"eq","keyValue":"job"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"b8fcc259-6d45-4e71-9c5c-5f76552eced8","name":"Update sync_state (jobs)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5424,480],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]); if (rows.length === 0) { return [{ json: { lastSyncIso: '1970-01-01T00:00:00Z' } }]; } const row = rows[0]; const last = row.last_sync_at || '1970-01-01T00:00:00Z'; const iso = new Date(last).toISOString(); return [{ json: { lastSyncIso: iso } }];"},"id":"a7df28f3-5389-4ec1-a620-d5148fff68f2","name":"Compute last_sync ISO (team)","type":"n8n-nodes-base.code","typeVersion":2,"position":[2064,960]},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies(ca9dc1bf-54ee-ed11-884a-000d3a455d5b)/ProyectosEquipos?$filter=lastModifiedDateTime%20ge%20' + $json.lastSyncIso }}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"8df2e3d1-4895-453f-8332-e889a7d00bf3","name":"HTTP - ProyectosEquipos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2288,960],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all(); if (input.length === 0) return []; const data = input[0].json; const equipos = data.value || []; const items = []; for (const e of equipos) { const job_no = String(e.job_no ?? '').trim(); const resource_no = String(e.resource_no ?? '').trim(); if (!job_no || !resource_no) continue; items.push({ json: { company_name: 'Power Solution Iberia SL', job_no, resource_no } }); } return items;"},"id":"50319172-6d3e-4d29-aa52-6f522bd498d3","name":"Transformar ProyectosEquipos","type":"n8n-nodes-base.code","typeVersion":2,"position":[2512,1056]},{"parameters":{"batchSize":300,"options":{}},"id":"3be5d732-a494-48c8-aa5a-8e254a683a72","name":"Split In Batches (upsert team)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[2736,1056]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json || {}); return [{ json: { payload: rows } }];"},"id":"78baa651-1461-4b3a-92d6-99eb2b900837","name":"Pack batch (team)","type":"n8n-nodes-base.code","typeVersion":2,"position":[2960,1056]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/job_team?on_conflict=company_name,job_no,resource_no","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"6d0400bb-07c7-4fe9-86d1-0c06a40e84b9","name":"HTTP - Upsert job_team (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[3184,1056]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"236c7b4b-3962-47a2-a180-76203e797cfb","name":"Compute now ISO (team)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,672]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"Power Solution Iberia SL"},{"keyName":"entity","condition":"eq","keyValue":"job_team"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"ddef0c4b-fa4a-464b-ab96-ee38cc10a88f","name":"Update sync_state (team)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5424,672],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]); if (rows.length === 0) { return [{ json: { lastSyncIso: '1970-01-01T00:00:00Z' } }]; } const row = rows[0]; const last = row.last_sync_at || '1970-01-01T00:00:00Z'; const iso = new Date(last).toISOString(); return [{ json: { lastSyncIso: iso } }];"},"id":"348f6691-f79d-498d-b4af-c18ff90eaf3e","name":"Compute last_sync ISO (resource_cost)","type":"n8n-nodes-base.code","typeVersion":2,"position":[3408,1056]},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies(ca9dc1bf-54ee-ed11-884a-000d3a455d5b)/RecursosCostos?$filter=lastModifiedDateTime%20ge%20' + $json.lastSyncIso }}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"38e3479c-7f85-4b57-8652-e6c9dca05719","name":"HTTP - RecursosCostos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[3632,1056],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all(); if (input.length === 0) return []; const data = input[0].json; const rows = data.value || []; const items = []; for (const r of rows) { const resource_no = String(r.resource_no ?? '').trim(); const work_type = String(r.work_type ?? '').trim(); const unit_cost = Number(r.unit_cost ?? 0); if (!resource_no || !work_type) continue; items.push({ json: { company_name: 'Power Solution Iberia SL', resource_no, work_type, unit_cost } }); } return items;"},"id":"76bafe15-fdcd-46d3-9d8b-b20858a33696","name":"Transformar RecursosCostos","type":"n8n-nodes-base.code","typeVersion":2,"position":[3856,1152]},{"parameters":{"batchSize":300,"options":{}},"id":"5324dd48-30ad-4ebd-998f-3ba4db44edfc","name":"Split In Batches (upsert resource_cost)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[4080,1152]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json || {}); return [{ json: { payload: rows } }];"},"id":"4ec171aa-711f-4536-9f34-6850c6964521","name":"Pack batch (resource_cost)","type":"n8n-nodes-base.code","typeVersion":2,"position":[4304,1152]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/resource_cost?on_conflict=company_name,resource_no,work_type","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"b4ffa78c-d839-4549-a5e9-649e2530df06","name":"HTTP - Upsert resource_cost (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[4528,1152]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"d43dd263-8600-4bcb-a832-3df01908e66e","name":"Compute now ISO (resource_cost)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,864]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"Power Solution Iberia SL"},{"keyName":"entity","condition":"eq","keyValue":"resource_cost"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"c8ebad33-ddee-4b09-be0e-14b5c83cc2b1","name":"Update sync_state (resource_cost)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5424,864],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"operation":"getAll","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').item.json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"calendar_period_days"}]}},"id":"0b6bdaf8-95aa-4880-b829-3263bd456f00","name":"Get sync_state (calendar)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4528,168],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]); if (rows.length === 0) { return [{ json: { lastSyncIso: '1970-01-01T00:00:00Z' } }]; } const row = rows[0]; const last = row.last_sync_at || '1970-01-01T00:00:00Z'; const iso = new Date(last).toISOString(); return [{ json: { lastSyncIso: iso } }];"},"id":"c6f17b6e-2230-4381-b2ae-9c679f2c5ef9","name":"Compute last_sync ISO (calendar)","type":"n8n-nodes-base.code","typeVersion":2,"position":[4752,168]},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies(ca9dc1bf-54ee-ed11-884a-000d3a455d5b)/CalendaroPeriodosDias?$filter=lastModifiedDateTime%20ge%20' + $json.lastSyncIso }}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"250a6a26-85ee-4fdf-a249-56b8b2c20aa6","name":"HTTP - CalendarPeriodDays (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[4976,168],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst data = input[0].json;\nconst rows = Array.isArray(data.value) ? data.value : [];\nconst items = [];\n\nfor (const r of rows) {\n  const allocation_period = String(r.allocation_period ?? r.allocationPeriod ?? '').trim();\n  const calendar_code = String(r.calendar_code ?? r.calendarCode ?? '').trim();\n  const dayRaw = r.day ?? r.Day ?? r.date ?? '';\n  const dayStr = String(dayRaw).trim();\n\n  if (!allocation_period) continue;\n  if (!dayStr) continue; // acepta '2025-01-01' o '1'\n\n  const holiday = Boolean(r.holiday ?? r.Holiday ?? false);\n  const hours_working = Number(r.hours_working ?? r.hoursWorking ?? 0);\n\n  // Si es número válido, envía número; si es 'YYYY-MM-DD', envía string (fecha)\n  const dayNum = Number(dayStr);\n  const day = Number.isNaN(dayNum) ? dayStr : dayNum;\n\n  items.push({\n    json: {\n      company_name: 'Power Solution Iberia SL',\n      allocation_period,\n      calendar_code,\n      day,\n      holiday,\n      hours_working,\n    },\n  });\n}\n\nreturn items;"},"id":"94e31c80-d72f-4a0e-b7db-b9ceab0c88bf","name":"Transformar CalendarPeriodDays","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,264]},{"parameters":{"batchSize":300,"options":{}},"id":"6d312261-11aa-437e-bed0-ffadec634990","name":"Split In Batches (upsert calendar)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[5424,264]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json || {}); return [{ json: { payload: rows } }];"},"id":"b353c41c-cded-4f0c-84e8-9bdc5b5d2276","name":"Pack batch (calendar)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5648,192]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/calendar_period_days?on_conflict=company_name,allocation_period,calendar_code,day","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"26287a67-d44e-42b3-91eb-657dc6d85807","name":"HTTP - Upsert calendar_period_days (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[5872,264]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"a25327d6-edf2-4523-b587-723f5d13088e","name":"Compute now ISO (calendar)","type":"n8n-nodes-base.code","typeVersion":2,"position":[5200,48]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"Power Solution Iberia SL"},{"keyName":"entity","condition":"eq","keyValue":"calendar_period_days"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"2d7604a3-b818-4dee-9f18-1535e51f4133","name":"Update sync_state (calendar)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5424,48],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"httpMethod":"POST","path":"ejecutar-sync-bc-to-supabase","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-1072,744],"id":"554425d1-8198-4744-ad9c-4811d0163f86","name":"Webhook Trigger","webhookId":"daab7c5f-dbf9-43a5-a291-37c7715b2789"},{"parameters":{"jsCode":"const p = $json.params || {};\nconst slugRaw = (p.company || $json.query?.company || '').toString().trim().toLowerCase();\nconst slug = encodeURI(slugRaw);\nconst map = {\n  'iberia': { companyName: 'Power Solution Iberia SL', companyId: 'ca9dc1bf-54ee-ed11-884a-000d3a455d5b' },\n  'psi': { companyName: 'PS LAB CONSULTING SL', companyId: '656f8f0e-2bf4-ed11-8848-000d3a4baf18' },\n  'pslab': { companyName: 'PS LAB CONSULTING SL', companyId: '656f8f0e-2bf4-ed11-8848-000d3a4baf18' }\n};\nconst chosen = map[slug];\nif (!chosen) {\n  return [{ json: { error: 'Invalid company', slug } }];\n}\nreturn [{ json: { companyName: chosen.companyName, companyId: chosen.companyId, slug } }];"},"id":"resolve_company_001","name":"Resolve Company","type":"n8n-nodes-base.code","typeVersion":2,"position":[-848,744]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: true, message: \"Sincronización BC a Supabase completada exitosamente\", timestamp: new Date().toISOString() } }}","options":{}},"id":"581486a3-7083-4175-af34-9085b17bf81d","name":"Webhook Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[6528,832]}],"connections":{"Compute last_sync ISO (resource)":{"main":[[{"node":"HTTP - Recursos (filtrado)","type":"main","index":0}]]},"HTTP - Recursos (filtrado)":{"main":[[{"node":"Transformar Recursos","type":"main","index":0},{"node":"Compute now ISO (resource)","type":"main","index":0}]]},"Transformar Recursos":{"main":[[{"node":"Split In Batches (upsert)","type":"main","index":0}]]},"Split In Batches (upsert)":{"main":[[{"node":"Pack batch","type":"main","index":0}]]},"Pack batch":{"main":[[{"node":"HTTP - Upsert resource (Supabase REST)","type":"main","index":0}]]},"Compute now ISO (resource)":{"main":[[{"node":"Update sync_state (resource)","type":"main","index":0}]]},"Get sync_state (jobs)":{"main":[[{"node":"Compute last_sync ISO (jobs)","type":"main","index":0}]]},"Compute last_sync ISO (jobs)":{"main":[[{"node":"HTTP - Proyectos (filtrado)","type":"main","index":0}]]},"HTTP - Proyectos (filtrado)":{"main":[[{"node":"Transformar Proyectos","type":"main","index":0},{"node":"Compute now ISO (jobs)","type":"main","index":0}]]},"Transformar Proyectos":{"main":[[{"node":"Split In Batches (upsert jobs)","type":"main","index":0}]]},"Split In Batches (upsert jobs)":{"main":[[{"node":"Pack batch (jobs)","type":"main","index":0}]]},"Pack batch (jobs)":{"main":[[{"node":"HTTP - Upsert job (Supabase REST)","type":"main","index":0}]]},"Compute now ISO (jobs)":{"main":[[{"node":"Update sync_state (jobs)","type":"main","index":0}]]},"Compute last_sync ISO (tasks)":{"main":[[{"node":"HTTP - ProyectosTareas (filtrado)","type":"main","index":0}]]},"HTTP - ProyectosTareas (filtrado)":{"main":[[{"node":"Transformar ProyectosTareas","type":"main","index":0},{"node":"Compute now ISO (tasks)","type":"main","index":0}]]},"Transformar ProyectosTareas":{"main":[[{"node":"Split In Batches (upsert tasks)","type":"main","index":0}]]},"Split In Batches (upsert tasks)":{"main":[[{"node":"Pack batch (tasks)","type":"main","index":0}]]},"Pack batch (tasks)":{"main":[[{"node":"HTTP - Upsert job_task (Supabase REST)","type":"main","index":0}]]},"Compute now ISO (tasks)":{"main":[[{"node":"Update sync_state (tasks)","type":"main","index":0}]]},"Compute last_sync ISO (team)":{"main":[[{"node":"HTTP - ProyectosEquipos (filtrado)","type":"main","index":0}]]},"HTTP - ProyectosEquipos (filtrado)":{"main":[[{"node":"Transformar ProyectosEquipos","type":"main","index":0},{"node":"Compute now ISO (team)","type":"main","index":0}]]},"Transformar ProyectosEquipos":{"main":[[{"node":"Split In Batches (upsert team)","type":"main","index":0}]]},"Split In Batches (upsert team)":{"main":[[{"node":"Pack batch (team)","type":"main","index":0}]]},"Pack batch (team)":{"main":[[{"node":"HTTP - Upsert job_team (Supabase REST)","type":"main","index":0}]]},"Compute now ISO (team)":{"main":[[{"node":"Update sync_state (team)","type":"main","index":0}]]},"Compute last_sync ISO (resource_cost)":{"main":[[{"node":"HTTP - RecursosCostos (filtrado)","type":"main","index":0}]]},"HTTP - RecursosCostos (filtrado)":{"main":[[{"node":"Transformar RecursosCostos","type":"main","index":0},{"node":"Compute now ISO (resource_cost)","type":"main","index":0}]]},"Transformar RecursosCostos":{"main":[[{"node":"Split In Batches (upsert resource_cost)","type":"main","index":0}]]},"Split In Batches (upsert resource_cost)":{"main":[[{"node":"Pack batch (resource_cost)","type":"main","index":0}]]},"Pack batch (resource_cost)":{"main":[[{"node":"HTTP - Upsert resource_cost (Supabase REST)","type":"main","index":0}]]},"Compute now ISO (resource_cost)":{"main":[[{"node":"Update sync_state (resource_cost)","type":"main","index":0}]]},"Get sync_state (calendar)":{"main":[[{"node":"Compute last_sync ISO (calendar)","type":"main","index":0}]]},"Compute last_sync ISO (calendar)":{"main":[[{"node":"HTTP - CalendarPeriodDays (filtrado)","type":"main","index":0}]]},"HTTP - CalendarPeriodDays (filtrado)":{"main":[[{"node":"Transformar CalendarPeriodDays","type":"main","index":0},{"node":"Compute now ISO (calendar)","type":"main","index":0}]]},"Transformar CalendarPeriodDays":{"main":[[{"node":"Split In Batches (upsert calendar)","type":"main","index":0}]]},"Split In Batches (upsert calendar)":{"main":[[{"node":"Pack batch (calendar)","type":"main","index":0}]]},"Pack batch (calendar)":{"main":[[{"node":"HTTP - Upsert calendar_period_days (Supabase REST)","type":"main","index":0}]]},"Compute now ISO (calendar)":{"main":[[{"node":"Update sync_state (calendar)","type":"main","index":0}]]},"HTTP - Upsert job (Supabase REST)":{"main":[[{"node":"Compute last_sync ISO (resource)","type":"main","index":0},{"node":"Split In Batches (upsert jobs)","type":"main","index":0}]]},"HTTP - Upsert resource (Supabase REST)":{"main":[[{"node":"Compute last_sync ISO (team)","type":"main","index":0},{"node":"Split In Batches (upsert)","type":"main","index":0}]]},"HTTP - Upsert job_team (Supabase REST)":{"main":[[{"node":"Compute last_sync ISO (resource_cost)","type":"main","index":0},{"node":"Split In Batches (upsert team)","type":"main","index":0}]]},"HTTP - Upsert resource_cost (Supabase REST)":{"main":[[{"node":"Compute last_sync ISO (tasks)","type":"main","index":0},{"node":"Split In Batches (upsert resource_cost)","type":"main","index":0}]]},"Webhook Trigger":{"main":[[{"node":"Resolve Company","type":"main","index":0}]]},"Resolve Company":{"main":[[{"node":"Get sync_state (jobs)","type":"main","index":0},{"node":"Get sync_state (calendar)","type":"main","index":0}]]},"Update sync_state (jobs)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"Update sync_state (calendar)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"Update sync_state (resource)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"Update sync_state (team)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"Update sync_state (resource_cost)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"Update sync_state (tasks)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"HTTP - Upsert calendar_period_days (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert calendar)","type":"main","index":0}]]},"HTTP - Upsert job_task (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert tasks)","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Webhook Trigger":[{"json":{"name":"First item","code":1}},{"json":{"name":"Second item","code":2}}]},"versionId":"9016a827-a604-4f80-8ce1-85ae8760e6a3","triggerCount":1,"shared":[{"createdAt":"2025-09-03T06:32:12.601Z","updatedAt":"2025-09-03T06:32:12.601Z","role":"workflow:owner","workflowId":"XSYOmZ8mRuaXl6sg","projectId":"ijP8FvHt2ZVVaBt9","project":{"createdAt":"2025-08-25T17:25:17.353Z","updatedAt":"2025-08-25T17:27:29.880Z","id":"ijP8FvHt2ZVVaBt9","name":"Daniel Bertona Sanchez <dbertona@powersolution.es>","type":"personal","icon":null,"description":null,"projectRelations":[{"createdAt":"2025-08-25T17:25:17.353Z","updatedAt":"2025-08-25T17:25:17.353Z","role":"project:personalOwner","userId":"b802b4cc-8f5c-4608-9aec-e44abff8bf5d","projectId":"ijP8FvHt2ZVVaBt9","user":{"createdAt":"2025-08-25T17:25:16.887Z","updatedAt":"2025-09-02T22:04:24.000Z","id":"b802b4cc-8f5c-4608-9aec-e44abff8bf5d","email":"dbertona@powersolution.es","firstName":"Daniel","lastName":"Bertona Sanchez","personalizationAnswers":null,"settings":{"userActivated":true,"firstSuccessfulWorkflowId":"71xpeeX1apKTpNe0","userActivatedAt":1756717935545},"role":"global:owner","disabled":false,"mfaEnabled":false,"lastActiveAt":"2025-09-02","isPending":false}}]}}],"tags":[]}
