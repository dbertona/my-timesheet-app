{"createdAt":"2025-09-03T06:32:12.599Z","updatedAt":"2025-09-09T06:18:37.000Z","id":"XSYOmZ8mRuaXl6sg","name":"001_sincronizacion_completa_smart","active":true,"isArchived":false,"nodes":[{"parameters":{"url":"={{ \n  'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies('\n  + $('Resolve Company').first().json.companyId\n  + ')/ProyectosTareas?$filter=lastModifiedDateTime%20ge%20'\n  + $('Build sync_state map').first().json.syncStateByEntity['job_task']\n}}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"eb598ae4-f3fb-4d3a-a297-49d928950428","name":"HTTP - ProyectosTareas (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-672,1008],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst companyName = $('Resolve Company').first().json.companyName;\nconst jobSet = new Set(($('Build job set').first().json.jobNos || []).map(s => String(s).trim()));\n\nconst data = input[0].json;\nconst tareas = data.value || [];\nconst items = [];\n\nfor (const t of tareas) {\n  const job_no = String(t.projectNo ?? t.jobNo ?? t.job_no ?? '').trim();\n  const no = String(t.no ?? '').trim();\n  const description = String(t.description ?? '').trim() || 'Sin descripción';\n  if (!job_no || !no) continue;\n  if (!jobSet.has(job_no)) continue; // evita violar la FK\n\n  items.push({\n    json: { job_no, no, description, company_name: companyName },\n    pairedItem: { item: 0 },\n  });\n}\nreturn items;"},"id":"f60c14a8-b917-43c0-a95a-540d6dda951d","name":"Transformar ProyectosTareas","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,1008]},{"parameters":{"batchSize":100,"options":{}},"id":"c96fec34-ee0d-4413-b3e2-7482c85066be","name":"Split In Batches (upsert tasks)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-224,1008]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json); return [{ json: { payload: rows } }];"},"id":"1a23d236-5656-4922-b562-3629e5c43a2e","name":"Pack batch (tasks)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,936]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/job_task?on_conflict=company_name,job_no,no","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"daf6efdb-f9e8-480c-8aee-33469bce3f7c","name":"HTTP - Upsert job_task (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[224,1008]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"99a5de58-b670-45bd-b45b-4ce024ff3cff","name":"Compute now ISO (tasks)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,1008]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"job_task"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"381adc95-5788-49ce-8601-298c5811e125","name":"Update sync_state (tasks)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,1008],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"url":"={{ \n  'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies('\n  + $('Resolve Company').first().json.companyId\n  + ')/Recursos?$filter=lastModifiedDateTime%20ge%20'\n  + $('Build sync_state map').first().json.syncStateByEntity['resource']\n}}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"55974e7d-ce7f-477b-9e90-ab12696a6aac","name":"HTTP - Recursos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1792,360],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst first = input[0];\nconst data = first.json;\nconst recursos = data.value || [];\nconst items = [];\n\nconst company = $('Resolve Company').first().json.companyName; // <- dinámico\n\nfor (const r of recursos) {\n  const code = r.no || '';\n  const name = r.name || '';\n  const email = String(r.email ?? r.arbvrneMail ?? '').trim(); // prioriza email\n  const department = String(r.globalDimension1Code ?? r.department ?? '').trim();\n  const calendarRaw = r.calendar_type ?? r.calendarType ?? r.Calendario ?? r.calendario ?? '';\n  const calendar_type = String(calendarRaw).trim();\n\n  if (!email || !email.includes('@')) continue;\n  if (!department) continue;\n\n  items.push({\n    json: {\n      code,\n      name,\n      email,\n      department_code: department,\n      company_name: company, // <- aquí\n      calendar_type,\n    },\n  });\n}\n\nreturn items;"},"id":"fe6117cb-b2eb-4d38-82a9-8814b1439f4a","name":"Transformar Recursos","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1568,360]},{"parameters":{"batchSize":100,"options":{}},"id":"590dd63f-f930-4eed-8280-a9dafbb2b271","name":"Split In Batches (upsert)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-1344,360]},{"parameters":{"jsCode":"const rows = $input.all().map(i => {\n  const j = i.json || {};\n  return {\n    ...j,\n    calendar_type: (j.calendar_type && String(j.calendar_type).trim())\n      || (j.calendarType && String(j.calendarType).trim())\n      || 'DEFAULT' // valor por defecto\n  };\n});\nreturn [{ json: { payload: rows } }];"},"id":"f919a1b1-8ac6-44b6-ac59-e9db75062ac7","name":"Pack batch","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1120,288]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/resource?on_conflict=company_name,code","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"2e0ac689-984c-4922-9097-e2c66e470823","name":"HTTP - Upsert resource (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-896,360]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"9e3d0f9a-4dd1-4da9-a0a9-2dc57fd7f405","name":"Compute now ISO (resource)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,576]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"resource"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"bdd182fb-747e-4e6f-8586-3fe53380b27f","name":"Update sync_state (resource)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,576],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"url":"={{ \n  'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies('\n  + $('Resolve Company').first().json.companyId\n  + ')/Proyectos?$filter=lastModifiedDateTime%20ge%20'\n  + $('Build sync_state map').first().json.syncStateByEntity['job']\n}}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"4ca688f5-c8f8-46cd-a941-965861dbd269","name":"HTTP - Proyectos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2912,768],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst companyName = $('Resolve Company').first().json.companyName; // <- dinámico\nconst data = input[0].json;\nconst proyectos = data.value || [];\nconst items = [];\n\nconst allowed = new Set(['Open','Planning','Completed','Lost']);\n\nfor (const p of proyectos) {\n  const statusRaw = p.estado ?? p.Estado ?? p.status ?? '';\n  const status = String(statusRaw).trim();\n  if (!allowed.has(status)) continue;\n\n  items.push({\n    json: {\n      no: p.no || '',\n      description: p.description || '',\n      status,\n      responsible: p.Responsible || p.responsible || '',\n      departamento: p.departamento || p.GlobalDimension1Code || '',\n      company_name: companyName, // <- aquí\n    },\n    pairedItem: { item: 0 },\n  });\n}\n\nreturn items;"},"id":"e0233d2c-e68a-4292-9c8d-cd5c7d73645a","name":"Transformar Proyectos","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2688,768]},{"parameters":{"batchSize":100,"options":{}},"id":"3ca7e906-aabe-4750-b4ad-d8907f4fb01f","name":"Split In Batches (upsert jobs)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-2464,768]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json); return [{ json: { payload: rows } }];"},"id":"eaf8d437-3462-4b74-9af6-b1139dee74cd","name":"Pack batch (jobs)","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2240,696]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/job?on_conflict=company_name,no","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"5075ce87-5761-4016-8559-0828adae87ed","name":"HTTP - Upsert job (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2016,768]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"94714d76-84fb-482d-9f48-675dedbf4c58","name":"Compute now ISO (jobs)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,768]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"job"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"535539f0-9b54-4851-a1d1-72fdbfbd5633","name":"Update sync_state (jobs)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,768],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"url":"={{ \n  'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies('\n  + $('Resolve Company').first().json.companyId\n  + ')/ProyectosEquipos?$filter=lastModifiedDateTime%20ge%20'\n  + $('Build sync_state map').first().json.syncStateByEntity['job_team']\n}}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"04c724de-473f-4b45-be47-f8f276116e99","name":"HTTP - ProyectosEquipos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-672,72],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst data = input[0].json;\nconst equipos = data.value || [];\nconst items = [];\n\nconst companyName = $('Resolve Company').first().json.companyName; // compañía dinámica\n\nfor (const e of equipos) {\n  const job_no = String(e.job_no ?? e.jobNo ?? e.NoProyecto ?? '').trim();\n  const resource_no = String(e.resource_no ?? e.resourceNo ?? e.NoRecurso ?? '').trim();\n  if (!job_no || !resource_no) continue;\n\n  items.push({\n    json: {\n      company_name: companyName,\n      job_no,\n      resource_no,\n    },\n    pairedItem: { item: 0 },\n  });\n}\n\nreturn items;"},"id":"cc68c7f2-f822-4eb6-aed2-1e555595aa59","name":"Transformar ProyectosEquipos","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,72]},{"parameters":{"batchSize":100,"options":{}},"id":"19aea5bc-a965-4d22-a2b1-4df395f9a1e9","name":"Split In Batches (upsert team)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-224,72]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/job_team?on_conflict=company_name,job_no,resource_no","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"2899a3d7-50d2-4152-a46b-45d4ab6bb2f5","name":"HTTP - Upsert job_team (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[224,72]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"74171126-f88d-4cee-b0ae-174c88c68e9e","name":"Compute now ISO (team)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,72]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"job_team"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"821cd4f3-96f7-448c-b288-cf8d9936acef","name":"Update sync_state (team)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,72],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"url":"={{ \n  'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies('\n  + $('Resolve Company').first().json.companyId\n  + ')/RecursosCostos?$filter=lastModifiedDateTime%20ge%20'\n  + $('Build sync_state map').first().json.syncStateByEntity['resource_cost']\n}}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"0dc0e740-6e0a-43c3-9218-16c982b1d1d7","name":"HTTP - RecursosCostos (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-672,360],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst data = input[0].json;\nconst rows = data.value || [];\nconst items = [];\n\nconst companyName = $('Resolve Company').first().json.companyName; // dinámico\n\nfor (const r of rows) {\n  const resource_no = String(r.resource_no ?? r.resourceNo ?? r.noRecurso ?? '').trim();\n  const work_type = String(r.work_type ?? r.workType ?? r.tipoTrabajo ?? '').trim();\n  const unit_cost = Number(r.unit_cost ?? r.unitCost ?? r.costoUnitario ?? 0);\n\n  if (!resource_no || !work_type) continue;\n\n  items.push({\n    json: {\n      company_name: companyName,\n      resource_no,\n      work_type,\n      unit_cost,\n    },\n    pairedItem: { item: 0 },\n  });\n}\n\nreturn items;"},"id":"b482e7aa-ac7f-4659-9865-0a7afd79c3a8","name":"Transformar RecursosCostos","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,360]},{"parameters":{"batchSize":100,"options":{}},"id":"3f70c5a2-425a-4acc-b397-15c10325deca","name":"Split In Batches (upsert resource_cost)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-224,360]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json || {}); return [{ json: { payload: rows } }];"},"id":"b6ebda4e-3233-4250-a0bb-f9d6a516c825","name":"Pack batch (resource_cost)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,288]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/resource_cost?on_conflict=company_name,resource_no,work_type","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"586adbd0-d54c-46ec-a66c-2c73c383f39f","name":"HTTP - Upsert resource_cost (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[224,360]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"b02d68d5-586a-481a-88ed-d0623a27cc72","name":"Compute now ISO (resource_cost)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,360]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"resource_cost"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"3119fe19-8365-49d2-8e28-a31705fa1c5f","name":"Update sync_state (resource_cost)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,360],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"url":"={{ 'https://api.businesscentral.dynamics.com/v2.0/a18dc497-a8b8-4740-b723-65362ab7a3fb/Pruebas_PS/api/Power_Solution/PS_API/v2.0/companies('\n  + $('Resolve Company').first().json.companyId\n  + ')/CalendaroPeriodosDias?$filter=lastModifiedDateTime%20ge%20'\n  + $('Build sync_state map').first().json.syncStateByEntity['calendar_period_days']\n}}","authentication":"genericCredentialType","genericAuthType":"oAuth2Api","options":{"timeout":60000}},"id":"cf23f324-e4db-4e4a-b739-60f875bcf63c","name":"HTTP - CalendarPeriodDays (filtrado)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-672,1296],"credentials":{"oAuth2Api":{"id":"5caHilW1m87Snw87","name":"Business Central"}}},{"parameters":{"jsCode":"const input = $input.all();\nif (input.length === 0) return [];\n\nconst companyName = $('Resolve Company').first().json.companyName; // <- añade esto\n\nconst data = input[0].json;\nconst rows = Array.isArray(data.value) ? data.value : [];\nconst items = [];\n\nfor (const r of rows) {\n  const allocation_period = String(r.allocation_period ?? r.allocationPeriod ?? '').trim();\n  const calendar_code = String(r.calendar_code ?? r.calendarCode ?? '').trim();\n  const dayRaw = r.day ?? r.Day ?? r.date ?? '';\n  const dayStr = String(dayRaw).trim();\n\n  if (!allocation_period) continue;\n  if (!dayStr) continue;\n\n  const holiday = Boolean(r.holiday ?? r.Holiday ?? false);\n  const hours_working = Number(r.hours_working ?? r.hoursWorking ?? 0);\n\n  const dayNum = Number(dayStr);\n  const day = Number.isNaN(dayNum) ? dayStr : dayNum;\n\n  items.push({\n    json: {\n      company_name: companyName,\n      allocation_period,\n      calendar_code,\n      day,\n      holiday,\n      hours_working,\n    },\n  });\n}\n\nreturn items;"},"id":"90c1a1d7-1079-485b-afbe-b14d77b7692f","name":"Transformar CalendarPeriodDays","type":"n8n-nodes-base.code","typeVersion":2,"position":[-448,1296]},{"parameters":{"batchSize":100,"options":{}},"id":"6a54cd6c-1dac-4968-90ba-717ffb692783","name":"Split In Batches (upsert calendar)","type":"n8n-nodes-base.splitInBatches","typeVersion":1,"position":[-224,1296]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json || {}); return [{ json: { payload: rows } }];"},"id":"9c23de10-36f7-403a-8fcc-81e30dd2742d","name":"Pack batch (calendar)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,1224]},{"parameters":{"method":"POST","url":"https://qfpswxjunoepznrpsltt.supabase.co/rest/v1/calendar_period_days?on_conflict=company_name,allocation_period,calendar_code,day","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Authorization","value":"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFmcHN3eGp1bm9lcHpucnBzbHR0Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1Mzg3MTA3OSwiZXhwIjoyMDY5NDQ3MDc5fQ.PxpfuFsfvpeEPHCEiWhRn0SD1WxngTAEppJ-65QTTOQ"},{"name":"Content-Type","value":"application/json"},{"name":"Prefer","value":"resolution=merge-duplicates,return=representation"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.payload }}","options":{"timeout":60000}},"id":"b9a9899a-3406-4ab4-ab95-1956f823cd3e","name":"HTTP - Upsert calendar_period_days (Supabase REST)","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[224,1296]},{"parameters":{"jsCode":"return [{ json: { nowIso: new Date().toISOString() } }];"},"id":"ee69d5fe-d9b4-49c6-a782-86173129dde8","name":"Compute now ISO (calendar)","type":"n8n-nodes-base.code","typeVersion":2,"position":[448,1296]},{"parameters":{"operation":"update","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"},{"keyName":"entity","condition":"eq","keyValue":"calendar_period_days"}]},"fieldsUi":{"fieldValues":[{"fieldId":"last_sync_at","fieldValue":"={{ $json.nowIso }}"}]}},"id":"d63566fd-43e3-4cad-bfb1-c8815367d6c5","name":"Update sync_state (calendar)","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,1296],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"httpMethod":"POST","path":"ejecutar-sync-bc-to-supabase","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[-4032,1152],"id":"c43cff0e-6a0e-4da7-8696-b0805f0873c9","name":"Webhook Trigger","webhookId":"8a27722f-ef0b-42c3-abb3-32ab91bda2a3"},{"parameters":{"jsCode":"const p = $json.params || {};\nconst slugRaw = (p.company || $json.query?.company || '').toString().trim().toLowerCase();\nconst slug = encodeURI(slugRaw);\nconst map = {\n  'psi': { companyName: 'Power Solution Iberia SL', companyId: 'ca9dc1bf-54ee-ed11-884a-000d3a455d5b' },\n  'pslab': { companyName: 'PS LAB CONSULTING SL', companyId: '656f8f0e-2bf4-ed11-8848-000d3a4baf18' }\n};\nconst chosen = map[slug];\nif (!chosen) {\n  return [{ json: { error: 'Invalid company', slug } }];\n}\nreturn [{ json: { companyName: chosen.companyName, companyId: chosen.companyId, slug } }];"},"id":"c1a10893-6b29-41ae-8463-6130b587dd41","name":"Resolve Company","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3584,1056]},{"parameters":{"respondWith":"json","responseBody":"={{ { success: true, message: \"Sincronización BC a Supabase completada exitosamente\", timestamp: new Date().toISOString() } }}","options":{}},"id":"f45eec82-8db5-432f-9d48-e4a38a5a2f08","name":"Webhook Response","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[896,672]},{"parameters":{"jsCode":"const rows = $input.all().map(i => i.json || {}); return [{ json: { payload: rows } }];"},"id":"3f69d8ce-fd8a-40db-acab-e6a99f8b26c9","name":"Pack batch (team)","type":"n8n-nodes-base.code","typeVersion":2,"position":[0,0]},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]);\n\n// Entidades que nos interesan\nconst entities = ['job','job_task','calendar_period_days','job_team','resource','resource_cost'];\n\nconst byEntity = {};\nfor (const r of rows) {\n  const e = String(r.entity || '').trim();\n  const raw = String(r.last_sync_at || '').trim();\n  if (!e || !raw) continue;\n  const iso = new Date(raw.replace(' ', 'T')).toISOString();\n  byEntity[e] = iso;\n}\n\n// NO lanzar error: devolver faltantes para que el flujo las salte\nconst missing = entities.filter(e => !(e in byEntity));\n\nreturn [{\n  json: {\n    syncStateByEntity: byEntity,\n    missing,\n    company: $('Resolve Company').first().json.companyName,\n  }\n}];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3136,1056],"id":"ad0a7542-9dae-4532-8004-db00e168578f","name":"Build sync_state map"},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-4032,960],"id":"bfe67045-53f7-4b14-afa1-75f09a016a62","name":"When clicking ‘Execute workflow’"},{"parameters":{"assignments":{"assignments":[{"id":"18ae6cd4-9853-4694-ac15-bcf52e8e4597","name":"query.company","value":"pslab","type":"string"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3808,1056],"id":"b5e067af-e27c-4929-9b75-d36e15e55f6d","name":"Set Company"},{"parameters":{"operation":"getAll","tableId":"sync_state","matchType":"allFilters","filters":{"conditions":[{"keyName":"company_name","condition":"eq","keyValue":"={{ $('Resolve Company').first().json.companyName }}"}]}},"id":"16eddfcc-0c3f-4dd7-8948-e4a42a7d63df","name":"Get sync_state ALL","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3360,1056],"credentials":{"supabaseApi":{"id":"Qa0kL8CVFxjwQVZ5","name":"Supabase account"}}},{"parameters":{"jsCode":"const rows = $input.all().flatMap(i => Array.isArray(i.json) ? i.json : [i.json]);\n\n// En la tabla job la clave es \"no\" (y como fallback \"job_no\")\nconst jobNos = rows\n  .map(r => String(r.no ?? r.job_no ?? '').trim())\n  .filter(Boolean);\n\nreturn [{ json: { jobNos } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-896,1008],"id":"15a0d928-ff14-47ae-a58a-257f5121c6ee","name":"Build job set"}],"connections":{"HTTP - ProyectosTareas (filtrado)":{"main":[[{"node":"Transformar ProyectosTareas","type":"main","index":0}]]},"Transformar ProyectosTareas":{"main":[[{"node":"Split In Batches (upsert tasks)","type":"main","index":0}]]},"Split In Batches (upsert tasks)":{"main":[[{"node":"Pack batch (tasks)","type":"main","index":0}]]},"Pack batch (tasks)":{"main":[[{"node":"HTTP - Upsert job_task (Supabase REST)","type":"main","index":0}]]},"HTTP - Upsert job_task (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert tasks)","type":"main","index":0},{"node":"Compute now ISO (tasks)","type":"main","index":0}]]},"Compute now ISO (tasks)":{"main":[[{"node":"Update sync_state (tasks)","type":"main","index":0}]]},"Update sync_state (tasks)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"HTTP - Recursos (filtrado)":{"main":[[{"node":"Transformar Recursos","type":"main","index":0}]]},"Transformar Recursos":{"main":[[{"node":"Split In Batches (upsert)","type":"main","index":0}]]},"Split In Batches (upsert)":{"main":[[{"node":"Pack batch","type":"main","index":0}]]},"Pack batch":{"main":[[{"node":"HTTP - Upsert resource (Supabase REST)","type":"main","index":0}]]},"HTTP - Upsert resource (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert)","type":"main","index":0},{"node":"HTTP - ProyectosEquipos (filtrado)","type":"main","index":0},{"node":"HTTP - RecursosCostos (filtrado)","type":"main","index":0},{"node":"Compute now ISO (resource)","type":"main","index":0}]]},"Compute now ISO (resource)":{"main":[[{"node":"Update sync_state (resource)","type":"main","index":0}]]},"Update sync_state (resource)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"HTTP - Proyectos (filtrado)":{"main":[[{"node":"Transformar Proyectos","type":"main","index":0}]]},"Transformar Proyectos":{"main":[[{"node":"Split In Batches (upsert jobs)","type":"main","index":0}]]},"Split In Batches (upsert jobs)":{"main":[[{"node":"Pack batch (jobs)","type":"main","index":0}]]},"Pack batch (jobs)":{"main":[[{"node":"HTTP - Upsert job (Supabase REST)","type":"main","index":0}]]},"HTTP - Upsert job (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert jobs)","type":"main","index":0},{"node":"HTTP - Recursos (filtrado)","type":"main","index":0},{"node":"Build job set","type":"main","index":0},{"node":"Compute now ISO (jobs)","type":"main","index":0}]]},"Compute now ISO (jobs)":{"main":[[{"node":"Update sync_state (jobs)","type":"main","index":0}]]},"Update sync_state (jobs)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"HTTP - ProyectosEquipos (filtrado)":{"main":[[{"node":"Transformar ProyectosEquipos","type":"main","index":0}]]},"Transformar ProyectosEquipos":{"main":[[{"node":"Split In Batches (upsert team)","type":"main","index":0}]]},"Split In Batches (upsert team)":{"main":[[{"node":"Pack batch (team)","type":"main","index":0}]]},"HTTP - Upsert job_team (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert team)","type":"main","index":0},{"node":"Compute now ISO (team)","type":"main","index":0}]]},"Compute now ISO (team)":{"main":[[{"node":"Update sync_state (team)","type":"main","index":0}]]},"Update sync_state (team)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"HTTP - RecursosCostos (filtrado)":{"main":[[{"node":"Transformar RecursosCostos","type":"main","index":0}]]},"Transformar RecursosCostos":{"main":[[{"node":"Split In Batches (upsert resource_cost)","type":"main","index":0}]]},"Split In Batches (upsert resource_cost)":{"main":[[{"node":"Pack batch (resource_cost)","type":"main","index":0}]]},"Pack batch (resource_cost)":{"main":[[{"node":"HTTP - Upsert resource_cost (Supabase REST)","type":"main","index":0}]]},"HTTP - Upsert resource_cost (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert resource_cost)","type":"main","index":0},{"node":"Compute now ISO (resource_cost)","type":"main","index":0}]]},"Compute now ISO (resource_cost)":{"main":[[{"node":"Update sync_state (resource_cost)","type":"main","index":0}]]},"Update sync_state (resource_cost)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"HTTP - CalendarPeriodDays (filtrado)":{"main":[[{"node":"Transformar CalendarPeriodDays","type":"main","index":0}]]},"Transformar CalendarPeriodDays":{"main":[[{"node":"Split In Batches (upsert calendar)","type":"main","index":0}]]},"Split In Batches (upsert calendar)":{"main":[[{"node":"Pack batch (calendar)","type":"main","index":0}]]},"Pack batch (calendar)":{"main":[[{"node":"HTTP - Upsert calendar_period_days (Supabase REST)","type":"main","index":0}]]},"HTTP - Upsert calendar_period_days (Supabase REST)":{"main":[[{"node":"Split In Batches (upsert calendar)","type":"main","index":0},{"node":"Compute now ISO (calendar)","type":"main","index":0}]]},"Compute now ISO (calendar)":{"main":[[{"node":"Update sync_state (calendar)","type":"main","index":0}]]},"Update sync_state (calendar)":{"main":[[{"node":"Webhook Response","type":"main","index":0}]]},"Webhook Trigger":{"main":[[{"node":"Set Company","type":"main","index":0}]]},"Resolve Company":{"main":[[{"node":"Get sync_state ALL","type":"main","index":0}]]},"Pack batch (team)":{"main":[[{"node":"HTTP - Upsert job_team (Supabase REST)","type":"main","index":0}]]},"Build sync_state map":{"main":[[{"node":"HTTP - Proyectos (filtrado)","type":"main","index":0},{"node":"HTTP - CalendarPeriodDays (filtrado)","type":"main","index":0}]]},"When clicking ‘Execute workflow’":{"main":[[{"node":"Set Company","type":"main","index":0}]]},"Set Company":{"main":[[{"node":"Resolve Company","type":"main","index":0}]]},"Get sync_state ALL":{"main":[[{"node":"Build sync_state map","type":"main","index":0}]]},"Build job set":{"main":[[{"node":"HTTP - ProyectosTareas (filtrado)","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"49d3af68-b55d-40f3-8907-7b0caad4c174","triggerCount":1,"shared":[{"createdAt":"2025-09-03T06:32:12.601Z","updatedAt":"2025-09-03T06:32:12.601Z","role":"workflow:owner","workflowId":"XSYOmZ8mRuaXl6sg","projectId":"ijP8FvHt2ZVVaBt9","project":{"createdAt":"2025-08-25T17:25:17.353Z","updatedAt":"2025-08-25T17:27:29.880Z","id":"ijP8FvHt2ZVVaBt9","name":"Daniel Bertona Sanchez <dbertona@powersolution.es>","type":"personal","icon":null,"description":null,"projectRelations":[{"createdAt":"2025-08-25T17:25:17.353Z","updatedAt":"2025-08-25T17:25:17.353Z","role":"project:personalOwner","userId":"b802b4cc-8f5c-4608-9aec-e44abff8bf5d","projectId":"ijP8FvHt2ZVVaBt9","user":{"createdAt":"2025-08-25T17:25:16.887Z","updatedAt":"2025-09-08T22:10:03.000Z","id":"b802b4cc-8f5c-4608-9aec-e44abff8bf5d","email":"dbertona@powersolution.es","firstName":"Daniel","lastName":"Bertona Sanchez","personalizationAnswers":null,"settings":{"userActivated":true,"firstSuccessfulWorkflowId":"71xpeeX1apKTpNe0","userActivatedAt":1756717935545},"role":"global:owner","disabled":false,"mfaEnabled":false,"lastActiveAt":"2025-09-08","isPending":false}}]}}],"tags":[]}